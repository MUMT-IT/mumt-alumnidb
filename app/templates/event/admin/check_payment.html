{% extends "base.html" %}

{% block content %}
<section class="section">
  <div class="columns">
    <div class="column">
      <h1 class="title">{{participant.event.name}}</h1>
      <h1 class="subtitle">รายการชำระเงิน</h1>
      <table class="table is-bordered is-fullwidth">
        <thead>
        <th>ชื่อผู้ชำระเงิน</th>
        <th>จำนวนเงิน</th>
        <th>เวลาส่งหลักฐาน</th>
        <th>Slip</th>
        <th>ตรวจสอบแล้วเมื่อ</th>
        <th>หมายเหตุ</th>
        </thead>
        <tbody>
        {% for payment in participant.payments %}
        <tr>
          <td>{{participant}}
            <a hx-get="{{url_for('event.admin_edit_participant', participant_id=participant.id)}}" hx-target="#form-modal" hx-swap="innerHTML">
              <span class="icon">
                <i class="fa-solid fa-pencil"></i>
              </span>
            </a>
          </td>
          <td>{{payment.amount}}</td>
          <td>{{payment.create_datetime|localdatetime}}</td>
          <td>
            {% if payment.key %}
            <a class="button is-rounded is-info" href="{{url_for('event.download_file', key=payment.key, download_filename=payment.filename)}}">
              Download
            </a>
            {% endif %}
          </td>
          <td>
            {% if payment.approve_datetime %}
            {{payment.approve_datetime|localdatetime}}
            {% else %}
            <a hx-target="#form-modal"
               hx-swap="innerHTML"
               hx-get="{{url_for('event.approve_payment_batch', payment_id=payment.id)}}"
               class="button is-success is-rounded"
            >Approve</a>
            <a hx-target="#form-modal"
               hx-swap="innerHTML"
               hx-get="{{url_for('event.admin_add_payment_note', payment_id=payment.id)}}"
               class="button is-warning is-rounded"
            >Note</a>
            {% endif %}
          </td>
          <td>
            {{payment.note or ""}}
            <a hx-target="#form-modal"
               hx-swap="innerHTML"
               hx-get="{{url_for('event.admin_add_payment_note', payment_id=payment.id)}}">
              <span class="icon">
                <i class="fa-solid fa-pencil"></i>
              </span>
            </a>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      <div id="payment-form"></div>
      <div class="buttons is-centered">
        <a hx-get="{{url_for('event.admin_add_payment_record', participant_id=participant.id)}}"
           hx-target="#payment-form"
           hx-swap="innerHTML"
           class="button is-rounded is-link">เพิ่มรายการชำระเงิน</a>
        <a hx-post="{{url_for('event.admin_add_ticket', participant_id=participant.id)}}"
           hx-target="#payment-form"
           hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
           hx-swap="innerHTML"
           hx-confirm="ท่านแน่ใจว่าต้องการจองบัตรเพิ่ม"
           class="button is-rounded is-light is-link">เพิ่มบัตร</a>
      </div>
      <div id="form-modal"></div>
      <h2 class="titlbe is-size-4">รายการบัตรที่จอง</h2>
      <table class="table is-fullwidth">
        <thead>
        <th>หมายเลขบัตร</th>
        <th>ผู้ถือบัตร</th>
        <th>วันเวลาที่จอง</th>
        <th>ชำระเงิน</th>
        <th>หมายเหตุ</th>
        </thead>
        {% for ticket in participant.purchased_tickets %}
        <tr>
          <td>{{ticket.ticket_number}}</td>
          <td>
            {% if ticket.holder %}
            {{ticket.holder}}
            <a hx-get="{{url_for('event.admin_edit_participant', participant_id=ticket.holder_id)}}" hx-target="#form-modal" hx-swap="innerHTML">
              <span class="icon">
                <i class="fa-solid fa-pencil"></i>
              </span>
            </a>
            <a hx-delete="{{url_for('event.admin_release_ticket', ticket_id=ticket.id)}}"
               hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
               hx-confirm="ท่านต้องการปล่อยบัตรนี้หรือไม่"
               hx-target="#form-modal" hx-swap="innerHTML">
              <span class="icon">
                <i class="fa-solid fa-trash-can has-text-danger"></i>
              </span>
            </a>
            {% else %}
            <a href="{{url_for('event.admin_add_ticket_holder', ticket_id=ticket.id)}}"
               class="button is-rounded">
              <span class="icon">
                <i class="fa-solid fa-user-plus"></i>
              </span>
              <span>add</span>
            </a>
            {% endif %}
          </td>
          <td>{{ticket.create_datetime|localdatetime}}</td>
          <td>
            {{ticket.payment_datetime|localdatetime}}
          </td>
          <td>
            {{ticket.note or ''}}
            <a hx-get="{{url_for('event.admin_edit_ticket', ticket_id=ticket.id)}}" hx-target="#form-modal" hx-swap="innerHTML">
              <span class="icon">
                <i class="fa-solid fa-pencil"></i>
              </span>
            </a>
          </td>
        </tr>
        {% endfor %}
      </table>
      <div class="buttons">
        <a href="{{url_for('event.list_participants', event_id=participant.event_id)}}" class="button is-rounded is-primary">Home</a>
        <a href="{{url_for('event.list_payments', event_id=participant.event_id)}}" class="button is-rounded">Back</a>
      </div>
    </div>
  </div>
</section>
{% endblock %}